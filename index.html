<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ドット絵リサイザー</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            /* 市松模様背景のサイズ・色はここで調整可能 */
            --ichimatsu-size: 8px;
            --ichimatsu-a: #ffffff;
            --ichimatsu-b: #cfcfcf;
        }

        canvas {
            image-rendering: pixelated;
            max-width: 100%;
            background: transparent;
        }

        .ichimatsu {
            /* 45度の斜線2枚を半マスずらして重ね、市松を作る */
            background-image:
                linear-gradient(45deg, var(--ichimatsu-b) 25%, transparent 25%, transparent 75%, var(--ichimatsu-b) 75%),
                linear-gradient(45deg, var(--ichimatsu-b) 25%, transparent 25%, transparent 75%, var(--ichimatsu-b) 75%);
            /* 1枚目は原点、2枚目は「1マスぶん」ずらす */
            background-position: 0 0, var(--ichimatsu-size) var(--ichimatsu-size);
            /* 1レピートの大きさは「2マス×2マス」 */
            background-size: calc(var(--ichimatsu-size) * 2) calc(var(--ichimatsu-size) * 2);
            /* 透明部の下地になる色（もう一方の色） */
            background-color: var(--ichimatsu-a);
        }

        .drop {
            border: 2px dashed #888;
            border-radius: .5rem;
            padding: 2rem;
            text-align: center;
            color: #555;
            cursor: pointer;
        }

        .drop.drag {
            background: #f0f7ff;
            border-color: #0d6efd;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4">ドット絵リサイザー</h1>

        <!-- ファイル入力 -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">画像ファイル選択</label>
                    <input type="file" id="file" class="form-control"
                        accept="image/png, image/gif, image/webp, image/jpeg" />
                    <div class="form-text">PNG推奨（透過保持）</div>
                </div>
                <div id="drop" class="drop" role="button" tabindex="0">ここに画像をドラッグ＆ドロップ（クリックでも選択）</div>
            </div>
        </div>

        <!-- 設定 -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3 align-items-center mb-3">
                    <div class="col-auto">
                        <label class="col-form-label">倍率（整数）</label>
                    </div>
                    <div class="col-auto">
                        <input id="scale" type="number" min="1" step="1" value="4" class="form-control" />
                    </div>
                    <div class="col-auto">
                        <button id="fit2x" class="btn btn-outline-secondary">×2</button>
                        <button id="fit3x" class="btn btn-outline-secondary">×3</button>
                        <button id="fit4x" class="btn btn-outline-secondary">×4</button>
                    </div>
                </div>
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label class="col-form-label">出力形式</label>
                    </div>
                    <div class="col-auto">
                        <select id="format" class="form-select">
                            <option value="image/png">PNG</option>
                            <option value="image/webp">WebP</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="col-form-label">品質(WebP)</label>
                    </div>
                    <div class="col-auto">
                        <input id="quality" type="number" min="0" max="1" step="0.05" value="0.95"
                            class="form-control" />
                    </div>
                    <div class="col-auto">
                        <!-- 設定行どこかにトグルを1つ追加 -->
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="ichimatsuToggle">
                            <label class="form-check-label" for="ichimatsuToggle">市松模様背景</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button id="download" class="btn btn-primary">ダウンロード</button>
                        <a id="dlLink" class="btn btn-primary d-none" download>ダウンロード</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- プレビュー -->
        <div class="card">
            <div class="card-body">
                <h2 class="h5">プレビュー</h2>
                <div class="row g-3">
                    <div class="col-md-6">
                        <p class="fw-bold">入力</p>
                        <canvas id="src" class="border"></canvas>
                    </div>
                    <div class="col-md-6">
                        <p class="fw-bold">出力</p>
                        <canvas id="dst" class="border"></canvas>
                    </div>
                </div>
                <p id="meta" class="text-muted small mt-2"></p>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script>
        (() => {
            const fileInput = document.getElementById('file');
            const drop = document.getElementById('drop');
            const srcCanvas = document.getElementById('src');
            const dstCanvas = document.getElementById('dst');
            const scaleInput = document.getElementById('scale');
            const formatSel = document.getElementById('format');
            const qualityInput = document.getElementById('quality');
            const downloadBtn = document.getElementById('download');
            const dlLink = document.getElementById('dlLink');
            const meta = document.getElementById('meta');
            const fit2 = document.getElementById('fit2x');
            const fit3 = document.getElementById('fit3x');
            const fit4 = document.getElementById('fit4x');

            let fileName = 'image';
            let srcImg = null;

            const ctxSrc = srcCanvas.getContext('2d');
            const ctxDst = dstCanvas.getContext('2d');

            // 補間無効（にじみ防止）
            function disableSmoothing(ctx) {
                ctx.imageSmoothingEnabled = false;
                ctx.imageSmoothingQuality = 'low';
            }
            disableSmoothing(ctxSrc);
            disableSmoothing(ctxDst);

            function setStatus(w, h, s) {
                meta.textContent = `入力: ${w}×${h}px / 倍率: ${s} / 出力: ${w * s}×${h * s}px`;
            }

            function drawDst() {
                if (!srcImg) return;
                const s = Math.max(1, Math.floor(Number(scaleInput.value) || 1));
                scaleInput.value = s;

                const sw = srcImg.width, sh = srcImg.height;
                srcCanvas.width = sw; srcCanvas.height = sh;
                ctxSrc.clearRect(0, 0, sw, sh);
                ctxSrc.drawImage(srcImg, 0, 0);

                dstCanvas.width = sw * s;
                dstCanvas.height = sh * s;
                ctxDst.clearRect(0, 0, dstCanvas.width, dstCanvas.height);

                disableSmoothing(ctxDst);
                // 最近傍で拡大縮小
                ctxDst.drawImage(srcCanvas, 0, 0, sw, sh, 0, 0, sw * s, sh * s);

                setStatus(sw, sh, s);
            }

            // ファイル名のサニタイズ
            function sanitizeName(name) {
                return (name || 'image').replace(/\.[^.]+$/, '').replace(/[^\w\-]+/g, '_');
            }

            // 画像の読み込み
            function handleFile(file) {
                fileName = sanitizeName(file.name);
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.onload = () => {
                    srcImg = img;
                    drawDst();
                    URL.revokeObjectURL(url);
                };
                img.onerror = () => alert('画像の読み込みに失敗しました。');
                img.src = url;
            }

            // ファイル選択
            fileInput.addEventListener('change', e => {
                const f = e.target.files?.[0];
                if (f) handleFile(f);
            });

            // クリック/Enter/Spaceでファイル選択
            drop.addEventListener('click', () => fileInput.click());
            drop.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }
            });

            // ドラッグ＆ドロップ
            function prevent(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => drop.addEventListener(ev, prevent));
            drop.addEventListener('dragenter', () => drop.classList.add('drag'));
            drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
            drop.addEventListener('drop', e => {
                drop.classList.remove('drag');
                const f = e.dataTransfer.files?.[0];
                if (f) handleFile(f);
            });

            // クリップボードからのコピペに対応
            window.addEventListener('paste', (e) => {
                const items = [...(e.clipboardData?.items || [])];
                const it = items.find(i => i.type?.startsWith('image/'));
                if (it) {
                    const f = it.getAsFile();
                    if (f) handleFile(f);
                }
            });

            // 倍率変更
            scaleInput.addEventListener('input', drawDst);
            fit2.addEventListener('click', () => { scaleInput.value = 2; drawDst(); });
            fit3.addEventListener('click', () => { scaleInput.value = 3; drawDst(); });
            fit4.addEventListener('click', () => { scaleInput.value = 4; drawDst(); });

            // 品質(WebP)のON/OFF
            function syncQualityUI() {
                const isWebP = formatSel.value === 'image/webp';
                qualityInput.disabled = !isWebP;
                qualityInput.title = isWebP ? '' : 'PNGでは品質設定は無効です';
            }
            formatSel.addEventListener('change', syncQualityUI);
            syncQualityUI();

            // 市松模様背景のON/OFF
            const ichimatsuToggle = document.getElementById('ichimatsuToggle');
            ichimatsuToggle?.addEventListener('change', () => {
                [srcCanvas, dstCanvas].forEach(c => c.classList.toggle('ichimatsu', ichimatsuToggle.checked));
            });

            // ダウンロードボタン
            function canvasToBlob(canvas, type, quality) {
                return new Promise((res, rej) => {
                    canvas.toBlob(b => b ? res(b) : rej(new Error('toBlob失敗')), type, quality);
                });
            }
            async function downloadCurrent() {
                if (!srcImg) { alert('先に画像を読み込んでね。'); return; }
                const type = formatSel.value;
                const sfx = type === 'image/png' ? 'png' : 'webp';
                const q = Number(qualityInput.value) || 0.95;
                try {
                    const blob = await canvasToBlob(dstCanvas, type, q);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const s = Math.floor(Number(scaleInput.value) || 1);
                    a.href = url; a.download = `${fileName}_x${s}.${sfx}`; a.click();
                    setTimeout(() => URL.revokeObjectURL(url), 1500);
                } catch (e) {
                    console.error(e);
                    alert('エクスポートに失敗しました。');
                }
            }
            downloadBtn.addEventListener('click', downloadCurrent);

            // 初期メッセージ
            setStatus(0, 0, Number(scaleInput.value));
        })();
    </script>
</body>

</html>